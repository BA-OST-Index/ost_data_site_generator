{% from 'template/base/_macro.html' import anchor_new_tab, get_storypart_text_color_css, get_stu_type_text_color_css, generate_tooltip_anchor %}
{% set curr_lang = "en" %}

{# ------------------------------------------------------------------- #}
{# ------------------------------- 通用函数 --------------------------- #}
{# ------------------------------------------------------------------- #}

{% macro extract_storypart_all_desc(data) %}{% for i in data %}{{ i.desc.en|js_string_safe }}{% endfor %}{% endmacro %}
{% macro get_ordinal_number(number) %}{% if number == 1 %}1st{% elif number == 2 %}2nd{% elif number == 3 %}3rd{% else %}{{ number }}th{% endif %}{% endmacro %}

{# 代为调用 template_en 全局里的函数 #}
{% macro tracktype_to_name(track_type) %}{{ template_en.tracktype_to_name(track_type) }}{% endmacro %}
{% macro filetype_to_name(ft) %}{{ template_en.filetype_to_name(ft) }}{% endmacro %}
{% macro generate_story_url(story) %}{{ py_generate_story_url(curr_lang, story) }}{% endmacro %}

{# 通用的Story名称生成 #}
{% macro generate_story_name(story) %}{% set ft = story.filetype %}{% if ft == 15 %}<span><img src="/static/images/student/icon/{{ story.student.image.collection_texture }}.webp" class="icon-stu">{{ story.student.name.personal_name.en|js_string_safe }}&nbsp;Bond&nbsp;Story&nbsp;{{ story.pos.no }}&nbsp;{{ story.name.en|js_string_safe }}</span>{% elif ft == 14 %}<span>Event&nbsp;{{ story.parent_data.0.name.en|js_string_safe }}&nbsp;Story&nbsp;{{ story.pos.segment }}:&nbsp;{{ story.name.en|js_string_safe }}</span>{% else %}{{ filetype_to_name(ft) }}&nbsp;Story&nbsp;Volume&nbsp;{{ story.pos.volume }}&nbsp;Chapter&nbsp;{{ story.pos.chapter }}&nbsp;Episode&nbsp;{{ story.pos.segment }}:&nbsp;{{ story.name.en|js_string_safe }}{% endif %}{% endmacro %}

{# 通用的UI <a>生成 #}
{% macro generate_ui_anchor(ui) %}
    {% if ui.filetype == 32 %}
        {% set url %}/{{ curr_lang }}/event/{{ ui.event_id }}/ui/{{ ui.id }}.html#track{% endset %}
    {% else %}
        {% set url %}/{{ curr_lang }}/ui/{{ ui.namespace.1 }}.html#track{% endset %}
    {% endif %}
    <span><a href="{{ url }}" target="_blank">{{ ui.name.en|js_string_safe }}</a>&nbsp;-&nbsp;{{ ui.desc.en|js_string_safe }}</span>
{% endmacro %}

{# 通用的Track <a>生成 #}
{% macro generate_track_anchor(track, with_counter, count_num, html_id, tooltip_id, enable_author) %}
    <a href="/{{ curr_lang }}/track/{{ track.namespace.1 }}/{{ track.namespace.2 }}.html{% if arg_check(html_id) %}#{{ html_id }}{% endif %}" {% if arg_check(tooltip_id) %}{{ generate_tooltip_anchor(tooltip_id) }}{% endif %}>
        <span>{% if arg_check(with_counter) %}【{{ count_num }}】{% endif %}{{ filetype_to_name(track.filetype) }}&nbsp;{{ track.no }}.&nbsp;{{ track.name.realname.en|js_string_safe }}</span>
    </a>
    {% if arg_check(enable_author) %}<span>&nbsp;by&nbsp;{{ track.composer.nickname }}</span>{% endif %}
{% endmacro %}

{# 通用的Background <a>生成 #}
{% macro generate_background_anchor(bg, html_id, tooltip_id) %}
    <div id="{{ bg.uuid }}">
        <img src="{{ bg.image.value }}" {% if arg_check(tooltip_id) %}onmouseover="showTooltipGallerySmall(this)" data-tooltip="{{ tooltip_id }}"{% endif %}>
        <p class="gallery-caption">
            <a href="/{{ curr_lang }}/background/{{ bg.filename }}.html{% if arg_check(html_id) %}#{{ html_id }}{% endif %}" {% if arg_check(tooltip_id) %}{{ generate_tooltip_anchor(tooltip_id) }}{% endif %} target="_blank">{{ bg.filename|js_string_safe }}</a>
        </p>
    </div>
{% endmacro %}

{# 通用的Character <a>生成 #}
{% macro generate_character_anchor(char, with_school, with_club, html_id, tooltip_id, show_combatant_info, is_leader, new_tab) %}
    {% if char.filetype == 52 %}
        <a href="/{{ curr_lang }}/character/npc/{{ char.namespace[-1]|lower }}/{% if arg_check(html_id) %}#{{ html_id }}{% endif %}" {% if arg_check(tooltip_id) %}{{ generate_tooltip_anchor(tooltip_id) }}{% endif %} {{ anchor_new_tab(new_tab) }}>
            <span>{{ char.name.en|js_string_safe }}</span>
        </a>
    {% else %}
        {% if arg_check(show_combatant_info) %}
            {% if arg_check(is_leader) %}<img src="/static/images/ui/Image_Conquest_Leader.png" class="story-battle-leader">{% endif %}
            <span><b class="{{ get_stu_type_text_color_css(char.combatant_info.squad_type.type) }}">{{ char.combatant_info.squad_type.lang.en }}</b>&nbsp;&#124;</span>
        {% endif %}
        {% if arg_check(with_school) %}
            <img src="/static/images/schoolicon/School_Icon_{{ char.school_id|upper }}_W.png" class="invert-light schoolicon-p">
        {% endif %}
        <span>
            <a href="/{{ curr_lang }}/character/student/{{ char.name.path_name|lower }}/{% if arg_check(html_id) %}#{{ html_id }}{% endif %}" {% if arg_check(tooltip_id) %}{{ generate_tooltip_anchor(tooltip_id) }}{% endif %} {{ anchor_new_tab(new_tab) }}>
                <img src="/static/images/student/icon/{{ char.image.collection_texture }}.webp" class="icon-stu">
                <span>{{ char.name.personal_name.en|js_string_safe }}</span>
            </a>
        </span>
        {% if arg_check(show_combatant_info) %}
            <span>&nbsp;
                <span class="{{ get_stu_type_text_color_css(char.combatant_info.attack_type.type) }}">{{ char.combatant_info.attack_type.lang.en }}</span>&nbsp;/&nbsp;<span class="{{ get_stu_type_text_color_css(char.combatant_info.armor_type.type) }}">{{ char.combatant_info.armor_type.lang.en }}</span>
            </span>
        {% else %}
            {% if arg_check(with_club) %}
                <span>&nbsp;[{{ char.club.en|js_string_safe }}]</span>
            {% endif %}
        {% endif %}
    {% endif %}
{% endmacro %}

{# 通用的Story <a>生成 #}
{% macro generate_story_anchor(story, tooltip_id, new_tab) %}
    {% set value = story %}
    {% set target_url = generate_story_url(story) %}

    {% if value.filetype == 15 %}
        <a href="{{ target_url }}" {{ anchor_new_tab(new_tab) }} {% if arg_check(tooltip_id) %}{{ generate_tooltip_anchor(tooltip_id) }}{% endif %}>{{ generate_story_name(story) }}</a>
    {% elif value.filetype == 14 %}
        <a href="{{ target_url }}" {{ anchor_new_tab(new_tab) }} {% if arg_check(tooltip_id) %}{{ generate_tooltip_anchor(tooltip_id) }}{% endif %}>{{ generate_story_name(story) }}</a>
    {% else %}
        <a href="{{ target_url }}" {{ anchor_new_tab(new_tab) }} {% if arg_check(tooltip_id) %}{{ generate_tooltip_anchor(tooltip_id) }}{% endif %}>{{ generate_story_name(story) }}</a>
    {% endif %}
{% endmacro %}

{# 通用的Album <a>生成 #}
{% macro generate_album_anchor(album, new_tab) %}
    <span><a href="/{{ curr_lang }}/album/{{ album.no }}.html" {{ anchor_new_tab(new_tab) }}>{{ album.name.en }}&nbsp;({{ album.track_num }} discs)&nbsp;[{{ album.release_date_format }}]</a></span>
{% endmacro %}

{% macro get_social_for_composer(composer) %}
    <a href="{{ composer.contact.url.value }}" target="_blank"><img src="/static/images/social/{{ composer.contact.platform.en }}.png" class="social-logo">{{ composer.contact.url.platform.en }}: {{ composer.nickname }}</a>
{% endmacro %}

{# 生成story parts “出现于”(appearedAt) HTML代码 #}
{% macro generate_appearedat_html(base_story, parts) %}
    {% for i in parts %}
        {% set part = i.0 %}
        {% set loop_index = i.1 %}
        {% set seg_index = i.2 %}
        {% set tooltip_id = i.3 %}
        {% set ele_class = get_storypart_text_color_css(part) %}

        {% if loop.index == 1 %}
        <span>(appeared at&nbsp;</span>
        {% else %}
        <span>,&nbsp;</span>
        {% endif %}

        <span><a href="{{ generate_story_url(base_story) }}#story-part-{{ loop_index }}-seg-{{ seg_index }}" class="{{ ele_class }}" {% if arg_check(tooltip_id) %}{{ generate_tooltip_anchor(tooltip_id) }}{% endif %}><i>[{{ loop_index }}]&nbsp;{{ part.name.en|js_string_safe }}</i></a></span>
    {% endfor %}
    <span>)</span>
{% endmacro %}

{# 通用的Tag <a>生成 #}
{% macro tag_altogether(tags, instance_id) %}
    {% for tag in tags %}<a href="/en/tag/{{ tag.namespace[-1] }}.html{% if instance_id %}#{{ instance_id }}{% endif %}" target="_blank"><span class="badge badge-{{ tag.color_css }} badge-tag">{{ tag.name.en }}</span></a>&nbsp;{% endfor %}
{% endmacro %}

{# 平铺人物<a>生成 #}
{% macro generate_character_anchor_flat(characters, max_char) %}
    {% if not arg_check(max_char) %}{% set max_char = 99999 %}{% endif %}

    {% if characters|length != 0 %}
        {% set char_for_show = [] %}
        {% for i in characters %}
            {% if loop.index == max_char %}{% break %}
            {% else %}{% do char_for_show.append(i) %}
            {% endif %}
        {% endfor %}

        {% for char in char_for_show[:-1] %}<span>{{ generate_character_anchor(char, 0, 0, 0, 0, 0, 0, 0) }}&nbsp;|&nbsp;</span>{% endfor %}
        {{ generate_character_anchor(char_for_show[-1], 0, 0, 0, 0, 0, 0, 0) }}
        {% if characters|length > char_for_show|length %}<span>&nbsp;and more.</span>{% endif %}
    {% endif %}
{% endmacro %}
